title:: 【Reading Highlights】美团 O2O 排序解决方案——线下篇 - 美团技术团队
source:: https://tech.meituan.com/2015/12/07/rerank-solution-offline.html
summary:: 
tags:: [[简悦]] [[美团技术]]  [[推荐系统]]  [[特征工程]]  [[反复研读]]   [[reading_highlights]]
date:: 20220701  

- > 整个数据清洗的流程如下：

*   序列化：曝光、点击和下单数据从 Hive 表中读取，采用 schema 的处理方式，可以直接根据日志字段名来抽取相应的字段，不受日志字段增加或者减少的影响。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E6%95%B4%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E7%9A%84%E6%B5%81%E7%A8%8B%E5%A6%82%E4%B8%8B%EF%BC%9A%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A%E6%9B%9D%E5%85%89%E3%80%81%E7%82%B9%E5%87%BB%E5%92%8C%E4%B8%8B%E5%8D%95%E6%95%B0%E6%8D%AE%E4%BB%8E%20Hive%20%E8%A1%A8%E4%B8%AD%E8%AF%BB%E5%8F%96%EF%BC%8C%E9%87%87%E7%94%A8%20schema%20%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%A0%B9%E6%8D%AE%E6%97%A5%E5%BF%97%E5%AD%97%E6%AE%B5%E5%90%8D%E6%9D%A5%E6%8A%BD%E5%8F%96%E7%9B%B8%E5%BA%94%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E4%B8%8D%E5%8F%97%E6%97%A5%E5%BF%97%E5%AD%97%E6%AE%B5%E5%A2%9E%E5%8A%A0%E6%88%96%E8%80%85%E5%87%8F%E5%B0%91%E7%9A%84%E5%BD%B1%E5%93%8D%E3%80%82))

- > 序列化的过程中，如果日志字段不合法或者单一用户曝光、点击或下单超出设定的阈值，相关日志都会被清洗掉，避免数据对模型训练造成影响。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%97%A5%E5%BF%97%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%90%88%E6%B3%95%E6%88%96%E8%80%85%E5%8D%95%E4%B8%80%E7%94%A8%E6%88%B7%E6%9B%9D%E5%85%89%E3%80%81%E7%82%B9%E5%87%BB%E6%88%96%E4%B8%8B%E5%8D%95%E8%B6%85%E5%87%BA%E8%AE%BE%E5%AE%9A%E7%9A%84%E9%98%88%E5%80%BC%EF%BC%8C%E7%9B%B8%E5%85%B3%E6%97%A5%E5%BF%97%E9%83%BD%E4%BC%9A%E8%A2%AB%E6%B8%85%E6%B4%97%E6%8E%89%EF%BC%8C%E9%81%BF%E5%85%8D%E6%95%B0%E6%8D%AE%E5%AF%B9%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E9%80%A0%E6%88%90%E5%BD%B1%E5%93%8D%E3%80%82))

- > 数据标注：数据序列化之后在 HDFS 上保存三份文本文件，分别是曝光（Impression）、点击（Click）和下单（Order）。数据标注模块根据 globalid（一次搜索的全局唯一标示，类似于 sessionid）和相应的团购 id 为 key，将曝光、点击和下单关联起来，最终生成一份标注好是否被点击、下单、支付的标注数据。同时这份标注数据携带了本次展现的详细特征信息。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E6%95%B0%E6%8D%AE%E6%A0%87%E6%B3%A8%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E5%90%8E%E5%9C%A8%20HDFS%20%E4%B8%8A%E4%BF%9D%E5%AD%98%E4%B8%89%E4%BB%BD%E6%96%87%E6%9C%AC%E6%96%87%E4%BB%B6%EF%BC%8C%E5%88%86%E5%88%AB%E6%98%AF%E6%9B%9D%E5%85%89%EF%BC%88Impression%EF%BC%89%E3%80%81%E7%82%B9%E5%87%BB%EF%BC%88Click%EF%BC%89%E5%92%8C%E4%B8%8B%E5%8D%95%EF%BC%88Order%EF%BC%89%E3%80%82%E6%95%B0%E6%8D%AE%E6%A0%87%E6%B3%A8%E6%A8%A1%E5%9D%97%E6%A0%B9%E6%8D%AE%20globalid%EF%BC%88%E4%B8%80%E6%AC%A1%E6%90%9C%E7%B4%A2%E7%9A%84%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80%E6%A0%87%E7%A4%BA%EF%BC%8C%E7%B1%BB%E4%BC%BC%E4%BA%8E%20sessionid%EF%BC%89%E5%92%8C%E7%9B%B8%E5%BA%94%E7%9A%84%E5%9B%A2%E8%B4%AD%20id%20%E4%B8%BA%20key%EF%BC%8C%E5%B0%86%E6%9B%9D%E5%85%89%E3%80%81%E7%82%B9%E5%87%BB%E5%92%8C%E4%B8%8B%E5%8D%95%E5%85%B3%E8%81%94%E8%B5%B7%E6%9D%A5%EF%BC%8C%E6%9C%80%E7%BB%88%E7%94%9F%E6%88%90%E4%B8%80%E4%BB%BD%E6%A0%87%E6%B3%A8%E5%A5%BD%E6%98%AF%E5%90%A6%E8%A2%AB%E7%82%B9%E5%87%BB%E3%80%81%E4%B8%8B%E5%8D%95%E3%80%81%E6%94%AF%E4%BB%98%E7%9A%84%E6%A0%87%E6%B3%A8%E6%95%B0%E6%8D%AE%E3%80%82%E5%90%8C%E6%97%B6%E8%BF%99%E4%BB%BD%E6%A0%87%E6%B3%A8%E6%95%B0%E6%8D%AE%E6%90%BA%E5%B8%A6%E4%BA%86%E6%9C%AC%E6%AC%A1%E5%B1%95%E7%8E%B0%E7%9A%84%E8%AF%A6%E7%BB%86%E7%89%B9%E5%BE%81%E4%BF%A1%E6%81%AF%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/c20f0d23.png) [[系统流程]]  [[特征工程]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/c20f0d23.png))

- > 基础特征按来源可分为三部分：

*   1、Hive 表：有一些基础特征存储在 Hive 标注，如 POI 的名字、品类、团购数等。
*   2、离线计算：一些特征需要积累一段时间才能统计，如 POI 的点击率、销量等，这部分通过积累历史数据，然后经过 Map/Reduce 处理得到。
*   3、HDFS：特征矩阵可能融合第三方服务的特征，一般第三方服务将产生的特征按照约定的格式存储在 HDFS 上。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E5%9F%BA%E7%A1%80%E7%89%B9%E5%BE%81%E6%8C%89%E6%9D%A5%E6%BA%90%E5%8F%AF%E5%88%86%E4%B8%BA%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A1%E3%80%81Hive%20%E8%A1%A8%EF%BC%9A%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E7%89%B9%E5%BE%81%E5%AD%98%E5%82%A8%E5%9C%A8%20Hive%20%E6%A0%87%E6%B3%A8%EF%BC%8C%E5%A6%82%20POI%20%E7%9A%84%E5%90%8D%E5%AD%97%E3%80%81%E5%93%81%E7%B1%BB%E3%80%81%E5%9B%A2%E8%B4%AD%E6%95%B0%E7%AD%89%E3%80%822%E3%80%81%E7%A6%BB%E7%BA%BF%E8%AE%A1%E7%AE%97%EF%BC%9A%E4%B8%80%E4%BA%9B%E7%89%B9%E5%BE%81%E9%9C%80%E8%A6%81%E7%A7%AF%E7%B4%AF%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E6%89%8D%E8%83%BD%E7%BB%9F%E8%AE%A1%EF%BC%8C%E5%A6%82%20POI%20%E7%9A%84%E7%82%B9%E5%87%BB%E7%8E%87%E3%80%81%E9%94%80%E9%87%8F%E7%AD%89%EF%BC%8C%E8%BF%99%E9%83%A8%E5%88%86%E9%80%9A%E8%BF%87%E7%A7%AF%E7%B4%AF%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%84%B6%E5%90%8E%E7%BB%8F%E8%BF%87%20Map/Reduce%20%E5%A4%84%E7%90%86%E5%BE%97%E5%88%B0%E3%80%823%E3%80%81HDFS%EF%BC%9A%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E5%8F%AF%E8%83%BD%E8%9E%8D%E5%90%88%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%89%B9%E5%BE%81%EF%BC%8C%E4%B8%80%E8%88%AC%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E5%B0%86%E4%BA%A7%E7%94%9F%E7%9A%84%E7%89%B9%E5%BE%81%E6%8C%89%E7%85%A7%E7%BA%A6%E5%AE%9A%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%AD%98%E5%82%A8%E5%9C%A8%20HDFS%20%E4%B8%8A%E3%80%82))

- > 数据源统一格式为： poiid/dealid/bizareaid ‘\t’ name1:value1’\t’ name2:value2… 特征合并模块，将所有来源合并为一个大文件，通过 feature conf 配置的特征和特征顺序，将特征序列化，然后写入 Hive 表。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E6%95%B0%E6%8D%AE%E6%BA%90%E7%BB%9F%E4%B8%80%E6%A0%BC%E5%BC%8F%E4%B8%BA%EF%BC%9A%20poiid/dealid/bizareaid%20%E2%80%98%5Ct%E2%80%99%20name1:value1%E2%80%99%5Ct%E2%80%99%20name2:value2%E2%80%A6%20%E7%89%B9%E5%BE%81%E5%90%88%E5%B9%B6%E6%A8%A1%E5%9D%97%EF%BC%8C%E5%B0%86%E6%89%80%E6%9C%89%E6%9D%A5%E6%BA%90%E5%90%88%E5%B9%B6%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%A4%A7%E6%96%87%E4%BB%B6%EF%BC%8C%E9%80%9A%E8%BF%87%20feature%20conf%20%E9%85%8D%E7%BD%AE%E7%9A%84%E7%89%B9%E5%BE%81%E5%92%8C%E7%89%B9%E5%BE%81%E9%A1%BA%E5%BA%8F%EF%BC%8C%E5%B0%86%E7%89%B9%E5%BE%81%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%20Hive%20%E8%A1%A8%E3%80%82))
  - 📝 斌哥之前的设计

- > 特征监控模块每天监控特征的分布等是否异常。 特征矩阵的特征每日更新。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%89%B9%E5%BE%81%E7%9B%91%E6%8E%A7%E6%A8%A1%E5%9D%97%E6%AF%8F%E5%A4%A9%E7%9B%91%E6%8E%A7%E7%89%B9%E5%BE%81%E7%9A%84%E5%88%86%E5%B8%83%E7%AD%89%E6%98%AF%E5%90%A6%E5%BC%82%E5%B8%B8%E3%80%82%20%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E7%9A%84%E7%89%B9%E5%BE%81%E6%AF%8F%E6%97%A5%E6%9B%B4%E6%96%B0%E3%80%82))

- > 添加新的特征来源，只需要按照约定的格式生成数据源，配置路径，可自动添加。

添加新特征，在 feature conf 文件末尾添加相应的特征名，特征名字和数据源中的特征 name 保持一致，最后修改相应的特征 Hive 表结构。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E7%89%B9%E5%BE%81%E6%9D%A5%E6%BA%90%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E6%8C%89%E7%85%A7%E7%BA%A6%E5%AE%9A%E7%9A%84%E6%A0%BC%E5%BC%8F%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%8C%E9%85%8D%E7%BD%AE%E8%B7%AF%E5%BE%84%EF%BC%8C%E5%8F%AF%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E3%80%82%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%89%B9%E5%BE%81%EF%BC%8C%E5%9C%A8%20feature%20conf%20%E6%96%87%E4%BB%B6%E6%9C%AB%E5%B0%BE%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%BA%94%E7%9A%84%E7%89%B9%E5%BE%81%E5%90%8D%EF%BC%8C%E7%89%B9%E5%BE%81%E5%90%8D%E5%AD%97%E5%92%8C%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%AD%E7%9A%84%E7%89%B9%E5%BE%81%20name%20%E4%BF%9D%E6%8C%81%E4%B8%80%E8%87%B4%EF%BC%8C%E6%9C%80%E5%90%8E%E4%BF%AE%E6%94%B9%E7%9B%B8%E5%BA%94%E7%9A%84%E7%89%B9%E5%BE%81%20Hive%20%E8%A1%A8%E7%BB%93%E6%9E%84%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/8b4a9b8e.png) [[系统流程]]  [[特征工程]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/8b4a9b8e.png))

- > 特征矩阵既提供在线的特征仓库，又可提供离线的特征调研。线上服务需要大量的特征来对 POI/DEAL 质量打分，特征分散会造成服务取用特征很耗时，特征矩阵将特征整合，很好的解决了特征耗时的问题。一般调研一个新特征需要积累一段时间的数据，将特征放入特征矩阵，然后和已有的数据进行融合，可方便的构造包含新特征的训练数据。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E6%97%A2%E6%8F%90%E4%BE%9B%E5%9C%A8%E7%BA%BF%E7%9A%84%E7%89%B9%E5%BE%81%E4%BB%93%E5%BA%93%EF%BC%8C%E5%8F%88%E5%8F%AF%E6%8F%90%E4%BE%9B%E7%A6%BB%E7%BA%BF%E7%9A%84%E7%89%B9%E5%BE%81%E8%B0%83%E7%A0%94%E3%80%82%E7%BA%BF%E4%B8%8A%E6%9C%8D%E5%8A%A1%E9%9C%80%E8%A6%81%E5%A4%A7%E9%87%8F%E7%9A%84%E7%89%B9%E5%BE%81%E6%9D%A5%E5%AF%B9%20POI/DEAL%20%E8%B4%A8%E9%87%8F%E6%89%93%E5%88%86%EF%BC%8C%E7%89%B9%E5%BE%81%E5%88%86%E6%95%A3%E4%BC%9A%E9%80%A0%E6%88%90%E6%9C%8D%E5%8A%A1%E5%8F%96%E7%94%A8%E7%89%B9%E5%BE%81%E5%BE%88%E8%80%97%E6%97%B6%EF%BC%8C%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E5%B0%86%E7%89%B9%E5%BE%81%E6%95%B4%E5%90%88%EF%BC%8C%E5%BE%88%E5%A5%BD%E7%9A%84%E8%A7%A3%E5%86%B3%E4%BA%86%E7%89%B9%E5%BE%81%E8%80%97%E6%97%B6%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%82%E4%B8%80%E8%88%AC%E8%B0%83%E7%A0%94%E4%B8%80%E4%B8%AA%E6%96%B0%E7%89%B9%E5%BE%81%E9%9C%80%E8%A6%81%E7%A7%AF%E7%B4%AF%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B0%86%E7%89%B9%E5%BE%81%E6%94%BE%E5%85%A5%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%EF%BC%8C%E7%84%B6%E5%90%8E%E5%92%8C%E5%B7%B2%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%9E%8D%E5%90%88%EF%BC%8C%E5%8F%AF%E6%96%B9%E4%BE%BF%E7%9A%84%E6%9E%84%E9%80%A0%E5%8C%85%E5%90%AB%E6%96%B0%E7%89%B9%E5%BE%81%E7%9A%84%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E3%80%82))

- > 在线方面的使用主要是方便特征的获取，将线上需要的特征纳入特征矩阵统一管理，通过配置文件读取特征矩阵的特征，封装成 Proto Buffers 写入 Medis（美团自主构建的 Redis 集群，支持分布式和容错），通过 Medis key 批量读取该 key 对应的特征，减少读取 Medis 的次数，从而缩减特征获取的时间，提高系统的性能。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E5%9C%A8%E7%BA%BF%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%BB%E8%A6%81%E6%98%AF%E6%96%B9%E4%BE%BF%E7%89%B9%E5%BE%81%E7%9A%84%E8%8E%B7%E5%8F%96%EF%BC%8C%E5%B0%86%E7%BA%BF%E4%B8%8A%E9%9C%80%E8%A6%81%E7%9A%84%E7%89%B9%E5%BE%81%E7%BA%B3%E5%85%A5%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%EF%BC%8C%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E7%9A%84%E7%89%B9%E5%BE%81%EF%BC%8C%E5%B0%81%E8%A3%85%E6%88%90%20Proto%20Buffers%20%E5%86%99%E5%85%A5%20Medis%EF%BC%88%E7%BE%8E%E5%9B%A2%E8%87%AA%E4%B8%BB%E6%9E%84%E5%BB%BA%E7%9A%84%20Redis%20%E9%9B%86%E7%BE%A4%EF%BC%8C%E6%94%AF%E6%8C%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%92%8C%E5%AE%B9%E9%94%99%EF%BC%89%EF%BC%8C%E9%80%9A%E8%BF%87%20Medis%20key%20%E6%89%B9%E9%87%8F%E8%AF%BB%E5%8F%96%E8%AF%A5%20key%20%E5%AF%B9%E5%BA%94%E7%9A%84%E7%89%B9%E5%BE%81%EF%BC%8C%E5%87%8F%E5%B0%91%E8%AF%BB%E5%8F%96%20Medis%20%E7%9A%84%E6%AC%A1%E6%95%B0%EF%BC%8C%E4%BB%8E%E8%80%8C%E7%BC%A9%E5%87%8F%E7%89%B9%E5%BE%81%E8%8E%B7%E5%8F%96%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%8C%E6%8F%90%E9%AB%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%80%A7%E8%83%BD%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/281a12ae.png) [[系统流程]]  [[特征工程]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/281a12ae.png))

- > *   序列化模块通过特征配置文件从特征矩阵抽取需要的特征，调用 protoBuffer Lib 将特征封装成 protoBuffer 的格式，写入 Medis。
*   线上通过 featureLoader 服务从 Medis 读取数据，然后通过 protoBufferLib 反序列化数据，取到相应的特征值。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E5%BA%8F%E5%88%97%E5%8C%96%E6%A8%A1%E5%9D%97%E9%80%9A%E8%BF%87%E7%89%B9%E5%BE%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8E%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E6%8A%BD%E5%8F%96%E9%9C%80%E8%A6%81%E7%9A%84%E7%89%B9%E5%BE%81%EF%BC%8C%E8%B0%83%E7%94%A8%20protoBuffer%20Lib%20%E5%B0%86%E7%89%B9%E5%BE%81%E5%B0%81%E8%A3%85%E6%88%90%20protoBuffer%20%E7%9A%84%E6%A0%BC%E5%BC%8F%EF%BC%8C%E5%86%99%E5%85%A5%20Medis%E3%80%82%E7%BA%BF%E4%B8%8A%E9%80%9A%E8%BF%87%20featureLoader%20%E6%9C%8D%E5%8A%A1%E4%BB%8E%20Medis%20%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%20protoBufferLib%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8F%96%E5%88%B0%E7%9B%B8%E5%BA%94%E7%9A%84%E7%89%B9%E5%BE%81%E5%80%BC%E3%80%82))

- > 离线方面的使用主要是方便调研新特征。如果从线上获取新特征，由于需要积累训练数据，特征调研的周期会变长；而如果将待调研的特征纳入特征矩阵中，可以很方便地通过离线的方法调研特征的有效性，极大的缩短了特征调研的周期，提高开发效率和模型迭代的速度。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%A6%BB%E7%BA%BF%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%BB%E8%A6%81%E6%98%AF%E6%96%B9%E4%BE%BF%E8%B0%83%E7%A0%94%E6%96%B0%E7%89%B9%E5%BE%81%E3%80%82%E5%A6%82%E6%9E%9C%E4%BB%8E%E7%BA%BF%E4%B8%8A%E8%8E%B7%E5%8F%96%E6%96%B0%E7%89%B9%E5%BE%81%EF%BC%8C%E7%94%B1%E4%BA%8E%E9%9C%80%E8%A6%81%E7%A7%AF%E7%B4%AF%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%89%B9%E5%BE%81%E8%B0%83%E7%A0%94%E7%9A%84%E5%91%A8%E6%9C%9F%E4%BC%9A%E5%8F%98%E9%95%BF%EF%BC%9B%E8%80%8C%E5%A6%82%E6%9E%9C%E5%B0%86%E5%BE%85%E8%B0%83%E7%A0%94%E7%9A%84%E7%89%B9%E5%BE%81%E7%BA%B3%E5%85%A5%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E4%B8%AD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BE%88%E6%96%B9%E4%BE%BF%E5%9C%B0%E9%80%9A%E8%BF%87%E7%A6%BB%E7%BA%BF%E7%9A%84%E6%96%B9%E6%B3%95%E8%B0%83%E7%A0%94%E7%89%B9%E5%BE%81%E7%9A%84%E6%9C%89%E6%95%88%E6%80%A7%EF%BC%8C%E6%9E%81%E5%A4%A7%E7%9A%84%E7%BC%A9%E7%9F%AD%E4%BA%86%E7%89%B9%E5%BE%81%E8%B0%83%E7%A0%94%E7%9A%84%E5%91%A8%E6%9C%9F%EF%BC%8C%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87%E5%92%8C%E6%A8%A1%E5%9E%8B%E8%BF%AD%E4%BB%A3%E7%9A%84%E9%80%9F%E5%BA%A6%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/50107fde.png) [[系统流程]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/50107fde.png))
  - 📝 离线特征调研

- > 特征融合的目的在于将待调研的新特征通过某一个 joinkey 合并到在线特征列表中，从而在模型训练中使用该特征。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%89%B9%E5%BE%81%E8%9E%8D%E5%90%88%E7%9A%84%E7%9B%AE%E7%9A%84%E5%9C%A8%E4%BA%8E%E5%B0%86%E5%BE%85%E8%B0%83%E7%A0%94%E7%9A%84%E6%96%B0%E7%89%B9%E5%BE%81%E9%80%9A%E8%BF%87%E6%9F%90%E4%B8%80%E4%B8%AA%20joinkey%20%E5%90%88%E5%B9%B6%E5%88%B0%E5%9C%A8%E7%BA%BF%E7%89%B9%E5%BE%81%E5%88%97%E8%A1%A8%E4%B8%AD%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%9C%A8%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%AF%A5%E7%89%B9%E5%BE%81%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/441208c4.png) [[系统流程]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/441208c4.png))
  - 📝 特征融合的框架

- > 特征融合模块可以指定任意一个或者多个 join key，将离线特征加入在线特征列表。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%89%B9%E5%BE%81%E8%9E%8D%E5%90%88%E6%A8%A1%E5%9D%97%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E6%88%96%E8%80%85%E5%A4%9A%E4%B8%AA%20join%20key%EF%BC%8C%E5%B0%86%E7%A6%BB%E7%BA%BF%E7%89%B9%E5%BE%81%E5%8A%A0%E5%85%A5%E5%9C%A8%E7%BA%BF%E7%89%B9%E5%BE%81%E5%88%97%E8%A1%A8%E3%80%82))

- > 线上监控主要是监测收集的在线特征日志是否正常，线上特征监控主要检测特征的覆盖度、阈值范围、分布异常三方面。

三方面的监控主要分以下几个场景：

*   覆盖度：监控特征的数据源是否存在或者有数据丢失。
*   阈值范围：监控特征的阈值是否符合预期，防止因为生成特征的算法改变或者在线计算方法的不同等因素造成特征的最大值或者最小值发生比较明显的变化，导致特征不可用。
*   分布异常：监控特征值的分布是否符合预期，主要防止因为获取不到特征，使得特征都使用了默认值，而又没有及时发现，导致线上模型预估出现偏差。分布异常主要用到了卡方距离 [[3](#ref-3)]。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%BA%BF%E4%B8%8A%E7%9B%91%E6%8E%A7%E4%B8%BB%E8%A6%81%E6%98%AF%E7%9B%91%E6%B5%8B%E6%94%B6%E9%9B%86%E7%9A%84%E5%9C%A8%E7%BA%BF%E7%89%B9%E5%BE%81%E6%97%A5%E5%BF%97%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8%EF%BC%8C%E7%BA%BF%E4%B8%8A%E7%89%B9%E5%BE%81%E7%9B%91%E6%8E%A7%E4%B8%BB%E8%A6%81%E6%A3%80%E6%B5%8B%E7%89%B9%E5%BE%81%E7%9A%84%E8%A6%86%E7%9B%96%E5%BA%A6%E3%80%81%E9%98%88%E5%80%BC%E8%8C%83%E5%9B%B4%E3%80%81%E5%88%86%E5%B8%83%E5%BC%82%E5%B8%B8%E4%B8%89%E6%96%B9%E9%9D%A2%E3%80%82%E4%B8%89%E6%96%B9%E9%9D%A2%E7%9A%84%E7%9B%91%E6%8E%A7%E4%B8%BB%E8%A6%81%E5%88%86%E4%BB%A5%E4%B8%8B%E5%87%A0%E4%B8%AA%E5%9C%BA%E6%99%AF%EF%BC%9A%E8%A6%86%E7%9B%96%E5%BA%A6%EF%BC%9A%E7%9B%91%E6%8E%A7%E7%89%B9%E5%BE%81%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%88%96%E8%80%85%E6%9C%89%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E3%80%82%E9%98%88%E5%80%BC%E8%8C%83%E5%9B%B4%EF%BC%9A%E7%9B%91%E6%8E%A7%E7%89%B9%E5%BE%81%E7%9A%84%E9%98%88%E5%80%BC%E6%98%AF%E5%90%A6%E7%AC%A6%E5%90%88%E9%A2%84%E6%9C%9F%EF%BC%8C%E9%98%B2%E6%AD%A2%E5%9B%A0%E4%B8%BA%E7%94%9F%E6%88%90%E7%89%B9%E5%BE%81%E7%9A%84%E7%AE%97%E6%B3%95%E6%94%B9%E5%8F%98%E6%88%96%E8%80%85%E5%9C%A8%E7%BA%BF%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%8D%E5%90%8C%E7%AD%89%E5%9B%A0%E7%B4%A0%E9%80%A0%E6%88%90%E7%89%B9%E5%BE%81%E7%9A%84%E6%9C%80%E5%A4%A7%E5%80%BC%E6%88%96%E8%80%85%E6%9C%80%E5%B0%8F%E5%80%BC%E5%8F%91%E7%94%9F%E6%AF%94%E8%BE%83%E6%98%8E%E6%98%BE%E7%9A%84%E5%8F%98%E5%8C%96%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%89%B9%E5%BE%81%E4%B8%8D%E5%8F%AF%E7%94%A8%E3%80%82%E5%88%86%E5%B8%83%E5%BC%82%E5%B8%B8%EF%BC%9A%E7%9B%91%E6%8E%A7%E7%89%B9%E5%BE%81%E5%80%BC%E7%9A%84%E5%88%86%E5%B8%83%E6%98%AF%E5%90%A6%E7%AC%A6%E5%90%88%E9%A2%84%E6%9C%9F%EF%BC%8C%E4%B8%BB%E8%A6%81%E9%98%B2%E6%AD%A2%E5%9B%A0%E4%B8%BA%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E7%89%B9%E5%BE%81%EF%BC%8C%E4%BD%BF%E5%BE%97%E7%89%B9%E5%BE%81%E9%83%BD%E4%BD%BF%E7%94%A8%E4%BA%86%E9%BB%98%E8%AE%A4%E5%80%BC%EF%BC%8C%E8%80%8C%E5%8F%88%E6%B2%A1%E6%9C%89%E5%8F%8A%E6%97%B6%E5%8F%91%E7%8E%B0%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%BA%BF%E4%B8%8A%E6%A8%A1%E5%9E%8B%E9%A2%84%E4%BC%B0%E5%87%BA%E7%8E%B0%E5%81%8F%E5%B7%AE%E3%80%82%E5%88%86%E5%B8%83%E5%BC%82%E5%B8%B8%E4%B8%BB%E8%A6%81%E7%94%A8%E5%88%B0%E4%BA%86%E5%8D%A1%E6%96%B9%E8%B7%9D%E7%A6%BB%20%5B3%5D%E3%80%82))

- > 离线监控主要检测两方面：

*   1、离线任务是否按时完成及生成的数据是否正确。
*   2、特征矩阵特征的有效性。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E7%A6%BB%E7%BA%BF%E7%9B%91%E6%8E%A7%E4%B8%BB%E8%A6%81%E6%A3%80%E6%B5%8B%E4%B8%A4%E6%96%B9%E9%9D%A2%EF%BC%9A1%E3%80%81%E7%A6%BB%E7%BA%BF%E4%BB%BB%E5%8A%A1%E6%98%AF%E5%90%A6%E6%8C%89%E6%97%B6%E5%AE%8C%E6%88%90%E5%8F%8A%E7%94%9F%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E3%80%822%E3%80%81%E7%89%B9%E5%BE%81%E7%9F%A9%E9%98%B5%E7%89%B9%E5%BE%81%E7%9A%84%E6%9C%89%E6%95%88%E6%80%A7%E3%80%82))

- > 模型训练框架支持多种模型的训练，将训练数据格式化为模型需要的输入格式。修改模型训练的配置文件，就可以使用该框架训练模型了。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%AE%AD%E7%BB%83%EF%BC%8C%E5%B0%86%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%BA%E6%A8%A1%E5%9E%8B%E9%9C%80%E8%A6%81%E7%9A%84%E8%BE%93%E5%85%A5%E6%A0%BC%E5%BC%8F%E3%80%82%E4%BF%AE%E6%94%B9%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E8%AF%A5%E6%A1%86%E6%9E%B6%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E4%BA%86%E3%80%82))

- > ![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/7f4921a1.png) [[系统架构]]  [[美团技术]]   ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2015/7f4921a1.png))
  - 📝 模型训练框架

- > 顶层是训练数据和测试数据的输入层，该层是原始训练和测试数据。

中间是模型训练的框架，框架支持多个配置项，包括配置模型算法、相应的参数、数据源的输入及模型的输出等。

底层是多种模型的实现，算法之前相互独立，每种算法封装成独立的 jar，提供给模型训练框架使用，目前支持的算法包括 GBDT[[4](#ref-4)]、FTRL[[5](#ref-5)]。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E9%A1%B6%E5%B1%82%E6%98%AF%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E5%92%8C%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E7%9A%84%E8%BE%93%E5%85%A5%E5%B1%82%EF%BC%8C%E8%AF%A5%E5%B1%82%E6%98%AF%E5%8E%9F%E5%A7%8B%E8%AE%AD%E7%BB%83%E5%92%8C%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E3%80%82%E4%B8%AD%E9%97%B4%E6%98%AF%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E6%A1%86%E6%9E%B6%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%8C%85%E6%8B%AC%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95%E3%80%81%E7%9B%B8%E5%BA%94%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E8%BE%93%E5%85%A5%E5%8F%8A%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%BE%93%E5%87%BA%E7%AD%89%E3%80%82%E5%BA%95%E5%B1%82%E6%98%AF%E5%A4%9A%E7%A7%8D%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E7%AE%97%E6%B3%95%E4%B9%8B%E5%89%8D%E7%9B%B8%E4%BA%92%E7%8B%AC%E7%AB%8B%EF%BC%8C%E6%AF%8F%E7%A7%8D%E7%AE%97%E6%B3%95%E5%B0%81%E8%A3%85%E6%88%90%E7%8B%AC%E7%AB%8B%E7%9A%84%20jar%EF%BC%8C%E6%8F%90%E4%BE%9B%E7%BB%99%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8%EF%BC%8C%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E7%9A%84%E7%AE%97%E6%B3%95%E5%8C%85%E6%8B%AC%20GBDT%5B4%5D%E3%80%81FTRL%5B5%5D%E3%80%82))

- > 为了实现模型的快速迭代，模型训练支持在 Spark 上运行。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E4%B8%BA%E4%BA%86%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%EF%BC%8C%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E6%94%AF%E6%8C%81%E5%9C%A8%20Spark%20%E4%B8%8A%E8%BF%90%E8%A1%8C%E3%80%82))

- > 实验结果表明 MAP 作为排序指标，对模型好坏的评估起到很好的指导作用。  ([🌐 摘要链接](https://tech.meituan.com/2015/12/07/rerank-solution-offline.html#js_content:~:text=%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C%E8%A1%A8%E6%98%8E%20MAP%20%E4%BD%9C%E4%B8%BA%E6%8E%92%E5%BA%8F%E6%8C%87%E6%A0%87%EF%BC%8C%E5%AF%B9%E6%A8%A1%E5%9E%8B%E5%A5%BD%E5%9D%8F%E7%9A%84%E8%AF%84%E4%BC%B0%E8%B5%B7%E5%88%B0%E5%BE%88%E5%A5%BD%E7%9A%84%E6%8C%87%E5%AF%BC%E4%BD%9C%E7%94%A8%E3%80%82))

